<!-- templates/billing_index.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åˆ—å°è¨ˆè²»ç³»çµ±</title>

<style>
body { font-family: Arial, "Microsoft JhengHei", sans-serif; padding: 20px; }
h1 { text-align: center; color: #333; }

/* ===== å°è¦½åˆ—æŒ‰éˆ• ===== */
.nav-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 15px;
}

.nav-buttons a {
    display: inline-block;
    padding: 8px 16px;
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    transition: background-color 0.2s;
}

.nav-btn-blue { background-color: #007BFF; }
.nav-btn-blue:hover { background-color: #0056b3; }

.nav-btn-green { background-color: #20c997; }
.nav-btn-green:hover { background-color: #198754; }

.nav-btn-gray { background-color: #6c757d; }
.nav-btn-gray:hover { background-color: #495057; }

/* è¡¨æ ¼æ¨£å¼ */
table { border-collapse: collapse; margin: 10px 0; width: 100%; max-width:900px; }
th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
th { background-color: #ccc; }

.contract-table th { text-align: center; background-color: #3399FF; color: white; }

/* è¡¨å–®èˆ‡æœå°‹ */
input[type="number"], input[type="text"], select { width: 140px; padding:4px; }
.search-label { font-size: 18px; }
.search-input { font-size: 16px; padding:4px 6px; }
.search-btn { font-size: 16px; padding: 6px 12px; cursor:pointer; }

button { cursor: pointer; padding: 6px 12px; border-radius: 5px; border: none; background-color: #007BFF; color: white; }
button:hover { background-color: #0056b3; }

.version-info { text-align: center; margin-bottom: 15px; font-size: 14px; color: #666; }
.msg { margin: 10px 0; color: green; font-weight: bold; }
.err { margin: 10px 0; color: red; font-weight: bold; }

/* æœ¬æœˆæŠ„è¡¨è¡¨å–®çµ±ä¸€å‚ç›´æ’åˆ— */
.form-column {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
}

/* æŒ‰éˆ•åŒåˆ— */
.button-row {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}
.button-row button, .button-row a button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
}
.save-btn { background-color: #28a745; }
.save-btn:hover { background-color: #218838; }
.invoice-btn { background-color: #17a2b8; }
.invoice-btn:hover { background-color: #138496; }

.billing-card {
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-top: 20px;
    background: #f9f9f9;
}
</style>
</head>

<body>
<div class="content-wrap">
    <h1>TGå®¢æˆ¶ç³»çµ±</h1>

    {% if version %}
        <div class="version-info">ç‰ˆæœ¬ï¼š{{ version }}</div>
    {% endif %}

    <!-- å°è¦½åˆ— -->
    <div class="nav-buttons">
        <a href="{{ url_for('billing.mfp_summary') }}" class="nav-btn-blue">å®¢æˆ¶ç¸½è¡¨</a>
        <a href="{{ url_for('billing.person_page', sheet='æ¹¯å®¶ç‘‹') }}" class="nav-btn-green">æ¹¯å®¶ç‘‹</a>
        <a href="{{ url_for('billing.person_page', sheet='å³å®—é´»') }}" class="nav-btn-green">å³å®—é´»</a>
        <a href="{{ url_for('billing.person_page', sheet='åŠ‰æŸå‡') }}" class="nav-btn-green">åŠ‰æŸå‡</a>
        <button type="button" onclick="history.back()" class="nav-btn-gray">
			â† è¿”å›ä¸Šä¸€é 
		</button>
        <a href="/" class="nav-btn-gray">å›é¦–é </a>
    </div>

    <!-- æŸ¥è©¢è¨­å‚™æˆ–å®¢æˆ¶ -->
    <form method="POST" style="margin-bottom: 12px;">
        <input type="hidden" name="mode" value="query">
        <label class="search-label">
            è¨­å‚™ç·¨è™Ÿ / å®¢æˆ¶åç¨±(æ¦‚ç•¥):
            <br>
            <input type="text" name="device_id" required class="search-input">
        </label>
        <button type="submit" class="search-btn">æŸ¥è©¢</button>
    </form>

    {% if message %}
        <div class="{{ 'msg' if message.startswith('âœ…') else 'err' }}">{{ message }}</div>
    {% endif %}

    <!-- è‹¥æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ -->
    {% if matches %}
    <div style="margin-top: 20px;">
        <h3>ğŸ” æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ï¼Œè«‹é¸æ“‡ï¼š</h3>
        <table border="1" cellspacing="0" cellpadding="6">
            <thead style="background-color: #f2f2f2;">
                <tr>
                    <th>è¨­å‚™ç·¨è™Ÿ</th>
                    <th>å®¢æˆ¶åç¨±</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for m in matches %}
                <tr>
                    <td>
                        <a href="{{ url_for('billing.index') }}?device_id={{m.device_id}}" style="text-decoration: none; color: blue;">
                            {{m.device_id}}
                        </a>
                    </td>
                    <td>{{m.customer_name}}</td>
                    <td>
                        <form method="post" action="{{ url_for('billing.index') }}" style="display:inline;">
                            <input type="hidden" name="mode" value="delete_customer">
                            <input type="hidden" name="device_id" value="{{ m.device_id }}">
                            <button type="submit" style="background-color: #e74c3c; color: white; border: none; padding: 2px 10px; font-size: 15px; border-radius: 4px; cursor: pointer;"
                                onclick="return confirm('ç¢ºå®šè¦åˆªé™¤ {{ m.customer_name }}ï¼ˆè¨­å‚™ç·¨è™Ÿï¼š{{ m.device_id }}ï¼‰å—ï¼Ÿ');">
                                ğŸ—‘ åˆªé™¤
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- å®¢æˆ¶è³‡æ–™å€å¡Š -->
    {% if customer %}
    <h3 style="font-size:22px;">å®¢æˆ¶è³‡æ–™</h3>
    <form method="post" action="{{ url_for('billing.index') }}">
        <table class="contract-table">
            <input type="hidden" name="device_id" value="{{ customer.device_id }}">
            <tr><th>é …ç›®</th><th>å…§å®¹</th></tr>
            <tr><td>è¨­å‚™ç·¨è™Ÿ</td><td><input type="text" name="device_id" value="{{ customer.device_id }}" style="width:98%;"></td></tr>
            <tr><td>å®¢æˆ¶åç¨±</td><td><input type="text" name="customer_name" value="{{ customer.customer_name }}" style="width:98%;"></td></tr>
			<tr>
				<td>æ–°è¨­å‚™ç·¨è™Ÿ</td>
				<td><input type="text" name="device_id_new" value=""></td>
			</tr>
            <tr><td>ä¿é¤Šé€±æœŸ</td><td><input type="text" name="pm" value="{{ customer.pm }}" style="width:98%;"></td></tr>
            <tr><td>è¨­å‚™æ©Ÿè™Ÿ</td><td><input type="text" name="device_number" value="{{ customer.device_number }}" style="width:98%;"></td></tr>
            <tr><td>æ©Ÿå‹</td><td><input type="text" name="machine_model" value="{{ customer.machine_model }}" style="width:98%;"></td></tr>
            <tr><td>çµ±ä¸€ç·¨è™Ÿ</td><td><input type="text" name="tax_id" value="{{ customer.tax_id }}" style="width:98%;"></td></tr>
            <tr><td>è£æ©Ÿåœ°å€</td><td><input type="text" name="install_address" value="{{ customer.install_address }}" style="width:98%;"></td></tr>
            <tr><td>æœå‹™äººå“¡</td><td><input type="text" name="service_person" value="{{ customer.service_person }}" style="width:98%;"></td></tr>
            <tr><td>å¥‘ç´„ç·¨è™Ÿ</td><td><input type="text" name="contract_number" value="{{ customer.contract_number }}" style="width:98%;"></td></tr>
            <tr><td>åˆç´„é–‹å§‹æ—¥</td><td><input type="text" name="contract_start" value="{{ customer.contract_start }}"></td></tr>
            <tr><td>åˆç´„åˆ°æœŸæ—¥</td><td><input type="text" name="contract_end" value="{{ customer.contract_end }}"></td></tr>
        </table>
        <div style="margin-top:10px; text-align:left;">
            <button type="submit" name="mode" value="update_customer">ğŸ’¾ æ›´æ–°å®¢æˆ¶è³‡æ–™</button>
            <button type="submit" name="mode" value="new_customer" style="margin-left:10px;">ğŸ†• æ–°å®¢æˆ¶å»ºæª”</button>
        </div>
    </form>
    {% endif %}

    <!-- æœ¬æœˆæŠ„è¡¨å€å¡Š -->
    {% if contract %}
	<div class="billing-card">
		<h3 style="margin-top:0; color:#007BFF;">ğŸ“Š æœ¬æœˆæŠ„è¡¨ â€” è¨­å‚™ï¼š{{ contract.device_id }}</h3>

		<form method="POST">
			<input type="hidden" name="device_id" value="{{ contract.device_id }}">
			<input type="hidden" name="mode" value="calculate">

			{% if related_devices and related_devices|length > 1 %}
			<!-- å¤šå°åˆé–‹ç¾¤çµ„ -->
			<p style="font-size:16px; color:#333;">ğŸ“¦ åˆé–‹ç¾¤çµ„ï¼ˆä¸»æ©Ÿï¼š{{ related_devices[0] }}ï¼‰ï¼Œå…± {{ related_devices|length }} å°</p>
			<table class="contract-table" style="width:100%; margin-top:8px;">
				<thead style="background:#007BFF; color:#fff;">
					<tr>
						<th>è¨­å‚™ç·¨è™Ÿ</th>
						<th>æœ¬æœˆå½©è‰²å¼µæ•¸</th>
						<th>æœ¬æœˆé»‘ç™½å¼µæ•¸</th>
					</tr>
				</thead>
				<tbody>
					{% for dev in related_devices %}
					<tr>
						<td style="font-weight:bold;">{{ dev }}</td>
						<td><input type="number" name="curr_color_{{ dev }}" style="width:100%; padding:4px;"></td>
						<td><input type="number" name="curr_bw_{{ dev }}" style="width:100%; padding:4px;"></td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% if last_time %}
			<p style="color:#555; font-size:14px;">ğŸ“… å‰æ¬¡æŠ„è¡¨æœˆä»½ï¼š{{ last_time }}</p>
			{% endif %}

			{% else %}
			<!-- å–®ä¸€è¨­å‚™ -->
			<div class="form-column">
				<div style="display:flex; gap:16px; margin-bottom:8px;">
					<div>
						<label for="selected_year">æŠ„è¡¨å¹´ä»½ï¼š</label><br>
						<select name="selected_year" id="selected_year" required style="padding:4px;">
							{% for y in range(current_year - 2, current_year + 2) %}
							<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }} å¹´</option>
							{% endfor %}
						</select>
					</div>
					<div>
						<label for="selected_month">æŠ„è¡¨æœˆä»½ï¼š</label><br>
						<select name="selected_month" id="selected_month" required style="padding:4px;">
							{% for m in range(1,13) %}
							<option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }} æœˆ</option>
							{% endfor %}
						</select>
					</div>
				</div>

				<div class="form-column">
					<div>
						<label>å‰æ¬¡å½©è‰²A3å¼µæ•¸ï¼š</label><br>
						<input id="prev-color-a3" type="text" value="{{ last_color_a3 }}" readonly style="width:100px; padding:4px;">
					</div>
					<div>
						<label>å‰æ¬¡å½©è‰²å¼µæ•¸ï¼š</label><br>
						<input id="prev-color" type="text" value="{{ last_color }}" readonly style="width:100px; padding:4px;">
					</div>
					<div>
						<label>å‰æ¬¡é»‘ç™½å¼µæ•¸ï¼š</label><br>
						<input id="prev-bw" type="text" value="{{ last_bw }}" readonly style="width:100px; padding:4px;">
					</div>
					<div>
						<p id="prev-date" style="color:#555; font-size:14px;">ğŸ“… å‰æ¬¡æŠ„è¡¨æœˆä»½ï¼š{{ last_time }}</p>
					</div>

					<div>
						<label>æœ¬æœˆå½©è‰²A3å¼µæ•¸ï¼š</label><br>
						<input type="number" name="curr_color_a3" required style="width:100px; padding:4px;">
					</div>
					<div>
						<label>æœ¬æœˆå½©è‰²å¼µæ•¸ï¼š</label><br>
						<input type="number" name="curr_color" required style="width:100px; padding:4px;">
					</div>
					<div>
						<label>æœ¬æœˆé»‘ç™½å¼µæ•¸ï¼š</label><br>
						<input type="number" name="curr_bw" required style="width:100px; padding:4px;">
					</div>
				</div>
			</div>
			{% endif %}

			<!-- æŒ‰éˆ•åŒåˆ— -->
			<div class="button-row">
				<button type="submit" class="save-btn">ğŸ’¾ è¨ˆç®—ä¸¦å„²å­˜æŠ„è¡¨</button>
				<a href="{{ url_for('billing.invoice_log', device_id=contract.device_id) }}">
					<button type="button" class="invoice-btn">ğŸ“„ ç™¼ç¥¨ç´€éŒ„</button>
				</a>
			</div>
		</form>
	</div>

    {% endif %}
	
    <!-- è¨ˆç®—çµæœ -->
    {% if result %}
    <hr>
    <h3 style="font-size:22px;">è¨ˆç®—çµæœ</h3>
    <table class="contract-table">
        <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
        {% for k, v in result.items() %}
        <tr {% if k in ["æœªç¨…å°è¨ˆ", "ç¨…é¡", "å«ç¨…ç¸½é¡"] %} style="background-color: #dfffd6;" {% endif %}>
            <td>{{ k }}</td>
            <td>{{ v }}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}
	
	{% if contract %}
    <!-- å¥‘ç´„æ¢ä»¶ -->
    <div class="header-flex" style="width:80%; margin-top:20px;">
        <h3 style="font-size:22px;">å¥‘ç´„æ¢ä»¶</h3>
    </div>

    {% if contra_text %}
    <div style="width:80%; margin-top:10px;">
        <div style="border: 1px solid #aaa; border-radius: 8px; padding: 10px; font-size: 15px; font-family: 'Microsoft JhengHei', sans-serif; white-space: pre-line; background-color:#f8f8f8;">
            {{ contra_text }}
        </div>
    </div>
    {% endif %}

    <form method="POST" style="margin-top:8px;">
        <input type="hidden" name="device_id" value="{{ contract.device_id }}">
        <input type="hidden" name="mode" value="update_contract">

        <table class="contract-table">
            <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
            <!-- æœˆç§Ÿ -->
            <tr><td>æœˆç§Ÿé‡‘</td><td><input type="number" step="0.01" name="monthly_rent" value="{{ contract.monthly_rent }}"></td></tr>
            <!-- å½©è‰²A3 -->
            <tr><td>å½©è‰²å–®åƒ¹ (A3)</td><td><input type="number" step="0.01" name="color_a3_unit_price" value="{{ contract.color_a3_unit_price }}"></td></tr>
            <tr><td>å½©è‰²A3åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="color_a3_basic" value="{{ contract.color_a3_basic }}"></td></tr>
            <tr><td>å½©è‰²A3è´ˆé€å¼µæ•¸</td><td><input type="number" name="color_a3_giveaway" value="{{ contract.color_a3_giveaway }}"></td></tr>
            <tr><td>å½©è‰²A3èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="color_a3_error_rate" value="{{ contract.color_a3_error_rate }}"></td></tr>
            <!-- å½©è‰² -->
            <tr><td>å½©è‰²å–®åƒ¹ (A4)</td><td><input type="number" step="0.01" name="color_unit_price" value="{{ contract.color_unit_price }}"></td></tr>
            <tr><td>å½©è‰²åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="color_basic" value="{{ contract.color_basic }}"></td></tr>
            <tr><td>å½©è‰²è´ˆé€å¼µæ•¸</td><td><input type="number" name="color_giveaway" value="{{ contract.color_giveaway }}"></td></tr>
            <tr><td>å½©è‰²èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="color_error_rate" value="{{ contract.color_error_rate }}"></td></tr>
            <!-- é»‘ç™½ -->
            <tr><td>é»‘ç™½å–®åƒ¹</td><td><input type="number" step="0.01" name="bw_unit_price" value="{{ contract.bw_unit_price }}"></td></tr>
            <tr><td>é»‘ç™½åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="bw_basic" value="{{ contract.bw_basic }}"></td></tr>
            <tr><td>é»‘ç™½è´ˆé€å¼µæ•¸</td><td><input type="number" name="bw_giveaway" value="{{ contract.bw_giveaway }}"></td></tr>
            <tr><td>é»‘ç™½èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="bw_error_rate" value="{{ contract.bw_error_rate }}"></td></tr>

            <!-- ç¨…åˆ¥ -->
            <tr>
                <td>ç¨…åˆ¥</td>
                <td>
                    <select name="tax_type">
                        <option value="æœªç¨…" {% if contract.tax_type == "æœªç¨…" %}selected{% endif %}>æœªç¨…</option>
                        <option value="å«ç¨…" {% if contract.tax_type == "å«ç¨…" %}selected{% endif %}>å«ç¨…</option>
                    </select>
                </td>
            </tr>
            <!-- ä¸»æ©Ÿ -->
            <tr>
                <td>åˆé–‹è¨­å‚™ç·¨è™Ÿï¼ˆä¸»è¦è¨­å‚™ï¼‰</td>
                <td><input type="text" name="master_device_id" value="{{ contract.master_device_id if contract.master_device_id else '' }}" placeholder="è‹¥ç‚ºä¸»æ©Ÿç•™ç©ºï¼Œå­æ©Ÿè«‹å¡«ä¸»æ©Ÿè¨­å‚™ç·¨è™Ÿ" style="width:98%;"></td>
            </tr>
        </table>

        <div style="margin-top:12px;">
            <button type="submit">æ›´æ–°å¥‘ç´„æ¢ä»¶</button>
        </div>
		{% endif %}
    </form>
</div>

<!-- å…¨åŸŸ Loading é®ç½© -->
<div id="global-loading" style="
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.4);
    z-index:9999;
    justify-content:center;
    align-items:center;
">
    <div style="
        background:white;
        padding:30px 50px;
        border-radius:12px;
        font-size:22px;
        font-weight:bold;
        box-shadow:0 4px 20px rgba(0,0,0,0.3);
    ">
        â³ åŠ è¼‰ä¸­...è«‹ç¨å¾Œ
    </div>
</div>
<script>
function showGlobalLoading() {
    const loading = document.getElementById("global-loading");
    if (loading) {
        loading.style.display = "flex";
    }
}

/* åªç›£è½çœŸæ­£æœƒè·³è½‰é é¢çš„ <a> */
document.addEventListener("click", function (e) {

    const link = e.target.closest("a");
    if (!link) return;

    const rawHref = link.getAttribute("href");

    // æ’é™¤ï¼š
    if (!rawHref ||
        rawHref.startsWith("javascript") ||
        rawHref.startsWith("#")) {
        return;
    }

    showGlobalLoading();
});

/* ç›£è½ form submitï¼ˆæ­£å¸¸æäº¤æ‰é¡¯ç¤ºï¼‰ */
document.addEventListener("submit", function () {
    showGlobalLoading();
});
</script>

<script>
window.addEventListener("pageshow", function (event) {
    const loading = document.getElementById("global-loading");

    if (loading) {
        loading.style.display = "none";
    }
});
</script>


<script>
function updateLastCounts() {
    const month = document.getElementById('selected_month').value;
    const year = document.getElementById('selected_year').value;
    const device_id = "{{ contract.device_id }}";

    fetch(`/billing/get_last_counts?device_id=${device_id}&year=${year}&month=${month}`)
    .then(res => res.json())
    .then(data => {
        document.getElementById('prev-color-a3').value = data.color_a3;
        document.getElementById('prev-color').value = data.color;
        document.getElementById('prev-bw').value = data.bw;
        document.getElementById('prev-date').innerText = `ğŸ“… å‰æ¬¡æŠ„è¡¨æœˆä»½ï¼š${data.prev_year} å¹´ ${data.prev_month} æœˆ`;
    })
    .catch(err => console.error(err));
}

document.getElementById('selected_month').addEventListener('change', updateLastCounts);
document.getElementById('selected_year').addEventListener('change', updateLastCounts);
</script>

</body>
</html>
