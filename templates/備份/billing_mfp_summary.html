{% extends 'layout.html' %}
{% block content %}

<!-- ================= å°è¦½åˆ— ================= -->
<div class="nav-buttons">
  <a href="{{ url_for('billing.index') }}">TGå®¢æˆ¶ç³»çµ±</a>
  <a href="{{ url_for('billing.mfp_summary') }}">å®¢æˆ¶ç¸½è¡¨</a>
  <a href="{{ url_for('billing.person_page', sheet='æ¹¯å®¶ç‘‹') }}">æ¹¯å®¶ç‘‹</a>
  <a href="{{ url_for('billing.person_page', sheet='å³å®—é´»') }}">å³å®—é´»</a>
  <a href="{{ url_for('billing.person_page', sheet='åŠ‰æŸå‡') }}">åŠ‰æŸå‡</a>
  <a href="javascript:history.back()">â† è¿”å›ä¸Šä¸€é </a>
  <a href="/">å›é¦–é </a>
</div>

<!-- ================= æ¨£å¼ ================= -->
<style>
/* ===== å°è¦½åˆ—æŒ‰éˆ• ===== */
.nav-buttons {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.nav-buttons a {
    display: inline-block;
    padding: 8px 16px;
    background-color: #007BFF; /* ä¸»è‰² */
    color: #fff;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    transition: background-color 0.2s;
    text-align: center;
}

.nav-buttons a:hover {
    background-color: #0056b3;
}

/* ç‰¹å®šæŒ‰éˆ•ä¸åŒé¡è‰² */
.nav-buttons a:nth-child(3),
.nav-buttons a:nth-child(4),
.nav-buttons a:nth-child(5) {
    background-color: #20c997; /* ç¶ è‰² */
}
.nav-buttons a:nth-child(3):hover,
.nav-buttons a:nth-child(4):hover,
.nav-buttons a:nth-child(5):hover {
    background-color: #198754;
}

/* ===== è¡¨æ ¼è‡ªé©æ‡‰ç•«é¢ï¼Œä¸çˆ†ç‰ˆ ===== */
.mfp-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
}

/* æ‰€æœ‰å…§å®¹é å·¦ã€å¯æ›è¡Œ */
.mfp-table th,
.mfp-table td {
    text-align: left !important;
    vertical-align: top;
    word-break: break-word;
    white-space: normal;
    padding: 6px 8px;
    font-size: 14px;
}

/* å°è¢å¹•è‡ªå‹•ç¸®å­— */
@media (max-width: 1400px) {
    .mfp-table th,
    .mfp-table td {
        font-size: 13px;
    }
}
@media (max-width: 1100px) {
    .mfp-table th,
    .mfp-table td {
        font-size: 12px;
    }
}

/* å®¢æˆ¶ç¸½è¡¨å®¹å™¨ */
.table-container.no-scroll {
    width: 100%;
    overflow-x: auto; /* æ°´å¹³å¯æ»‘å‹• */
    overflow-y: visible; /* å‚ç›´è‡ªå‹•æ’é–‹ */
}

/* æœå°‹æ¡† */
.search-box {
    margin: 10px 0 15px 0;
}
.search-box input {
    width: 320px;
    padding: 6px 10px;
    font-size: 16px;
}

/* æ·¡ç´…åº•è‰² */
.bg-warning {
    background-color: #ffcccc;
}

/* è¨­å‚™ä»£è™ŸæŒ‰éˆ• */
.device-btn {
    display: inline-block;
    padding: 4px 10px;
    background-color: #007BFF;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}
.device-btn:hover {
    background-color: #0056b3;
}
</style>

<!-- ================= å€åŸŸå°æ•¸ ================= -->
<h2>å€åŸŸå°æ•¸</h2>
<div class="table-container">
  <table class="mfp-table">
    <thead>
      <tr>{% for col in area_header %}<th>{{ col }}</th>{% endfor %}</tr>
    </thead>
    <tbody>
      {% for row in area_body %}
      <tr>{% for cell in row %}<td>{{ cell }}</td>{% endfor %}</tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= ä¿é¤Šé€±æœŸè©•ä¼° ================= -->
<h2>ä¿é¤Šé€±æœŸè©•ä¼°</h2>
<div class="table-container">
  <table class="mfp-table">
    <thead>
      <tr>{% for col in cycle_header %}<th>{{ col }}</th>{% endfor %}</tr>
    </thead>
    <tbody>
      {% for row in cycle_body %}
      <tr>{% for cell in row %}<td>{{ cell }}</td>{% endfor %}</tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= å®¢æˆ¶ç¸½è¡¨ ================= -->
<h2>å®¢æˆ¶ç¸½è¡¨</h2>
<div class="search-box">
  <input type="text" id="customerSearch" placeholder="å³æ™‚æœå°‹ï¼ˆå®¢æˆ¶ / è¨­å‚™ / åœ°å€ / å·¥ç¨‹å¸«â€¦ï¼‰">
</div>

<div class="table-container no-scroll">
  <table class="mfp-table" id="customerTable">
    <thead>
      <tr>
        <th>è¨­å‚™ä»£è™Ÿ</th>
        <th>å®¢æˆ¶åç¨±</th>
        <th>ä¿é¤Šé€±æœŸ</th>
        <th>è¨­å‚™æ©Ÿè™Ÿ</th>
        <th>æ©Ÿå‹</th>
        <th>çµ±ä¸€ç·¨è™Ÿ</th>
        <th>è£æ©Ÿåœ°å€</th>
        <th>å·¥ç¨‹å¸«</th>
        <th>å¥‘ç´„ç·¨è™Ÿ</th>
        <th>åˆç´„èµ·å§‹</th>
        <th>åˆç´„çµæŸ</th>
      </tr>
    </thead>
    <tbody>
      {% for row in tables %}
      <tr>
        <td>
          <a href="{{ url_for('billing.index') }}?device_id={{ row.device_id }}" class="device-btn">{{ row.device_id }}</a>
        </td>
        <td>{{ row.customer_name }}</td>
        <td>{{ row.pm|int }}</td>
        <td>{{ row.device_number|int }}</td>
        <td>{{ row.machine_model }}</td>
        <td>{{ row.tax_id|int }}</td>
        <td>{{ row.install_address }}</td>
        <td>{{ row.service_person }}</td>
        <td>{{ row.contract_number }}</td>
        <td class="date-cell">{{ row.contract_start }}</td>
        <td class="date-cell contract-end {% if row._contract_end_alert %}bg-warning{% endif %}">{{ row.contract_end }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= JS ================= -->
<script>
/* ğŸ” å³æ™‚æœå°‹ */
document.getElementById('customerSearch').addEventListener('input', function () {
    const keyword = this.value.toLowerCase();
    document.querySelectorAll('#customerTable tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(keyword) ? '' : 'none';
    });
});

/* ğŸ“… æ—¥æœŸæ ¼å¼åŒ– YYYY/MM/DD */
const today = new Date();
document.querySelectorAll('.date-cell').forEach(td => {
    const raw = td.innerText.trim();
    if (!raw) return;
    const d = new Date(raw);
    if (!isNaN(d)) {
        td.innerText = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    }
});

/* ğŸ”´ åˆç´„çµæŸå°æ–¼ä¸‰å€‹æœˆåº•è‰² */
document.querySelectorAll('.contract-end').forEach(td => {
    const raw = td.innerText.trim();
    if (!raw) return;
    const d = new Date(raw);
    if (!isNaN(d)) {
        const diffDays = (d - today)/(1000*60*60*24);
        if(diffDays >=0 && diffDays <=90){
            td.classList.add('bg-warning');
        }
    }
});
</script>

{% endblock %}
