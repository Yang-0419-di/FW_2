<!-- templates/billing_index.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>åˆ—å°è¨ˆè²»ç³»çµ±</title>
    <style>
        body { font-family: Arial, "Microsoft JhengHei", sans-serif; padding: 20px; }
        table { border-collapse: collapse; margin: 10px 0; width: 80%; }
        th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left;}
        th { background-color: #ccc !important; }
        .header-flex { display:flex; justify-content:space-between; align-items:center; width:80%; }
        .msg { margin: 10px 0; color: green; font-weight: bold; }
        .err { margin: 10px 0; color: red; font-weight: bold; }
        input[type="number"], input[type="text"] { width: 140px; }
        .btn-group { display:flex; gap:10px; margin-top: 10px; }
        table.contract-table th {text-align: center; background-color: #3399FF !important;color: white !important;}
        button {
            padding: 10px 15px;
            font-size: 18px;
            margin: 5px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        .search-label {
            font-size: 18px;
        }
        .search-input {
            font-size: 16px;
            padding: 4px 6px;
        }
        .search-btn {
            font-size: 16px;
            padding: 6px 12px;
        }
        .back-btn {
            background-color: #28a745;
            padding: 8px 14px;
            font-size: 16px;
        }
        .back-btn:hover {
            background-color: #1e7e34;
        }
    </style>
</head>
<body>
    <div class="header-flex">
        <h2>åˆ—å°è¨ˆè²»ç³»çµ±</h2>
        <a href="/" style="text-decoration:none;">
            <button class="back-btn">ğŸ”™ å›é¦–é </button>
        </a>
    </div>

	<!-- æŸ¥è©¢è¨­å‚™æˆ–å®¢æˆ¶ -->
	<form method="POST" style="margin-bottom: 12px;">
		<input type="hidden" name="mode" value="query">
		<label class="search-label">è¨­å‚™ç·¨è™Ÿ / å®¢æˆ¶åç¨±(æ¦‚ç•¥):
			<input type="text" name="device_id" required class="search-input">
		</label>
		<button type="submit" class="search-btn">æŸ¥è©¢</button>
	</form>

    {% if message %}
        <div class="{{ 'msg' if message.startswith('âœ…') else 'err' }}">{{ message }}</div>
    {% endif %}

	<!-- è‹¥æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ -->
	{% if matches %}
	  <div style="margin-top: 20px;">
		<h3>ğŸ” æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ï¼Œè«‹é¸æ“‡ï¼š</h3>
		<table border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 60%;">
		  <thead style="background-color: #f2f2f2;">
			<tr>
			  <th>è¨­å‚™ç·¨è™Ÿ</th>
			  <th>å®¢æˆ¶åç¨±</th>
			  <th>æ“ä½œ</th>
			</tr>
		  </thead>
		  <tbody>
			{% for m in matches %}
			<tr>
			  <td>
				<a href="{{ url_for('billing.index') }}?device_id={{m.device_id}}" style="text-decoration: none; color: blue;">
				  {{m.device_id}}
				</a>
			  </td>
			  <td>{{m.customer_name}}</td>
			  <td>
				<!-- åˆªé™¤å®¢æˆ¶æŒ‰éˆ• -->
				<form method="post" action="{{ url_for('billing.index') }}" style="display:inline;">
				  <input type="hidden" name="mode" value="delete_customer">
				  <input type="hidden" name="device_id" value="{{ m.device_id }}">
				  <button type="submit"
						  style="background-color: #e74c3c; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;"
						  onclick="return confirm('ç¢ºå®šè¦åˆªé™¤ {{ m.customer_name }}ï¼ˆè¨­å‚™ç·¨è™Ÿï¼š{{ m.device_id }}ï¼‰å—ï¼Ÿ');">
					ğŸ—‘ åˆªé™¤
				  </button>
				</form>
			  </td>
			</tr>
			{% endfor %}
		  </tbody>
		</table>
	  </div>
	{% endif %}


    {% if contract %}
    <hr>

<!-- å®¢æˆ¶è³‡æ–™å€å¡Š -->
	{% if customer %}
	<h3 style="font-size:22px;">å®¢æˆ¶è³‡æ–™</h3>
	<form method="post" action="{{ url_for('billing.index') }}">
		<table class="contract-table">
			<input type="hidden" name="device_id" value="{{ customer.device_id }}">
			<tr><th>é …ç›®</th><th>å…§å®¹</th></tr>
			<tr><td>å®¢æˆ¶åç¨±</td><td><input type="text" name="customer_name" value="{{ customer.customer_name }}" style="width:98%;"></td></tr>
			<tr><td>è¨­å‚™ç·¨è™Ÿ</td><td><input type="text" name="device_id_new" value="{{ customer.device_id }}" style="width:98%;"></td></tr>
			<tr><td>æ©Ÿè™Ÿ</td><td><input type="text" name="device_number" value="{{ customer.device_number }}" style="width:98%;"></td></tr>
			<tr><td>æ©Ÿå‹</td><td><input type="text" name="machine_model" value="{{ customer.machine_model }}" style="width:98%;"></td></tr>
			<tr><td>çµ±ä¸€ç·¨è™Ÿ</td><td><input type="text" name="tax_id" value="{{ customer.tax_id }}" style="width:98%;"></td></tr>
			<tr><td>è£æ©Ÿåœ°å€</td><td><input type="text" name="install_address" value="{{ customer.install_address }}" style="width:98%;"></td></tr>
			<tr><td>æœå‹™äººå“¡</td><td><input type="text" name="service_person" value="{{ customer.service_person }}" style="width:98%;"></td></tr>
			<tr><td>å¥‘ç´„ç·¨è™Ÿ</td><td><input type="text" name="contract_number" value="{{ customer.contract_number }}" style="width:98%;"></td></tr>
			<tr><td>åˆç´„é–‹å§‹æ—¥</td><td><input type="text" name="contract_start" value="{{ customer.contract_start }}"></td></tr>
			<tr><td>åˆç´„åˆ°æœŸæ—¥</td><td><input type="text" name="contract_end" value="{{ customer.contract_end }}"></td></tr>
		</table>

		<div style="margin-top:10px; text-align:left;">
			<button type="submit" name="mode" value="update_customer" class="btn btn-primary" style="font-size:16px;">ğŸ’¾ æ›´æ–°å®¢æˆ¶è³‡æ–™</button>
			<button type="submit" name="mode" value="new_customer" class="btn btn-success" style="font-size:16px; margin-left:10px;">ğŸ†• æ–°å®¢æˆ¶å»ºæª”</button>
		</div>
	</form>
	{% endif %}

	<!-- æœ¬æœˆæŠ„è¡¨è¡¨å–® -->
	<form method="POST" style="margin-top:20px;">
		<input type="hidden" name="device_id" value="{{ contract.device_id }}">
		<input type="hidden" name="mode" value="calculate">

		<div class="header-flex" style="font-size:18px;width:80%; margin-top:20px;">
			<h4>è¼¸å…¥ç•¶æœˆæŠ„è¡¨ï¼ˆå¯«å…¥è³‡æ–™åº«ï¼‰</h4>
		</div>

		{% if related_devices and related_devices|length > 1 %}
			<p style="font-size:16px;">ğŸ“¦ åˆé–‹ç¾¤çµ„ï¼ˆä¸»æ©Ÿï¼š{{ related_devices[0] }}ï¼‰ï¼Œå…± {{ related_devices|length }} å°</p>
			<table class="contract-table">
				<tr>
					<th>è¨­å‚™ç·¨è™Ÿ</th>
					<th>æœ¬æœˆå½©è‰²å¼µæ•¸</th>
					<th>æœ¬æœˆé»‘ç™½å¼µæ•¸</th>
				</tr>
				{% for dev in related_devices %}
				<tr>
					<td>{{ dev }}</td>
					<td><input type="number" name="curr_color_{{ dev }}" required></td>
					<td><input type="number" name="curr_bw_{{ dev }}" required></td>
				</tr>
				{% endfor %}
			</table>
		{% else %}
			<div>
				å‰æ¬¡å½©è‰²å¼µæ•¸: <input type="text" value="{{ last_color }}" readonly>
				å‰æ¬¡é»‘ç™½å¼µæ•¸: <input type="text" value="{{ last_bw }}" readonly>
			</div>
			<br>
			<div>
				æœ¬æœˆå½©è‰²å¼µæ•¸: <input type="number" name="curr_color" required>
				æœ¬æœˆé»‘ç™½å¼µæ•¸: <input type="number" name="curr_bw" required>
			</div>
		{% endif %}

		<div style="margin-top:12px;">
			<button type="submit">è¨ˆç®—ä¸¦å„²å­˜æœ¬æœˆæŠ„è¡¨</button>
		</div>
	</form>

    {% if result %}
    <hr>
    <h3 style="font-size:22px;">è¨ˆç®—çµæœ</h3>
    <table class="contract-table">
        <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
        {% for k, v in result.items() %}
        <tr {% if k in ["æœªç¨…å°è¨ˆ", "ç¨…é¡", "å«ç¨…ç¸½é¡"] %} style="background-color: #dfffd6;" {% endif %}>
            <td>{{ k }}</td>
            <td>{{ v }}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <!-- å¥‘ç´„æ¢ä»¶å€å¡Š -->
    <div class="header-flex" style="width:80%; margin-top:20px;">
        <h3 style="font-size:22px;">å¥‘ç´„æ¢ä»¶</h3>
    </div>
	
	{% if contra_text %}
	<div style="width:80%; margin-top:10px;">
		<div style="border: 1px solid #aaa; border-radius: 8px; padding: 10px; font-size: 15px; font-family: 'Microsoft JhengHei', sans-serif; white-space: pre-line; background-color:#f8f8f8;">
			{{ contra_text }}
		</div>
	</div>
	{% endif %}


    <form method="POST" style="margin-top:8px;">
        <input type="hidden" name="device_id" value="{{ contract.device_id }}">
        <input type="hidden" name="mode" value="update_contract">

        <table class="contract-table">
            <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
            <tr><td>æœˆç§Ÿé‡‘</td><td><input type="number" step="0.01" name="monthly_rent" value="{{ contract.monthly_rent }}"></td></tr>
            <tr><td>å½©è‰²å–®åƒ¹</td><td><input type="number" step="0.01" name="color_unit_price" value="{{ contract.color_unit_price }}"></td></tr>
            <tr><td>é»‘ç™½å–®åƒ¹</td><td><input type="number" step="0.01" name="bw_unit_price" value="{{ contract.bw_unit_price }}"></td></tr>
            <tr><td>å½©è‰²è´ˆé€å¼µæ•¸</td><td><input type="number" name="color_giveaway" value="{{ contract.color_giveaway }}"></td></tr>
            <tr><td>é»‘ç™½è´ˆé€å¼µæ•¸</td><td><input type="number" name="bw_giveaway" value="{{ contract.bw_giveaway }}"></td></tr>
            <tr><td>å½©è‰²èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="color_error_rate" value="{{ contract.color_error_rate }}"></td></tr>
            <tr><td>é»‘ç™½èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="bw_error_rate" value="{{ contract.bw_error_rate }}"></td></tr>
            <tr><td>å½©è‰²åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="color_basic" value="{{ contract.color_basic }}"></td></tr>
            <tr><td>é»‘ç™½åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="bw_basic" value="{{ contract.bw_basic }}"></td></tr>
            <tr><td>å‰æ¬¡å½©è‰²å¼µæ•¸</td><td><input type="text" value="{{ last_color }}" readonly></td></tr>
            <tr><td>å‰æ¬¡é»‘ç™½å¼µæ•¸</td><td><input type="text" value="{{ last_bw }}" readonly></td></tr>
			<tr>
			  <td>åˆé–‹è¨­å‚™ç·¨è™Ÿï¼ˆä¸»è¦è¨­å‚™ï¼‰</td>
			  <td>
				<input type="text" name="master_device_id" 
					   value="{{ contract.master_device_id if contract.master_device_id else '' }}" 
					   placeholder="è‹¥ç‚ºä¸»æ©Ÿç•™ç©ºï¼Œå­æ©Ÿè«‹å¡«ä¸»æ©Ÿè¨­å‚™ç·¨è™Ÿ" 
					   style="width:98%;">
			  </td>
			</tr>

			<tr><td>ç¨…åˆ¥</td>
                <td>
                    <select name="tax_type">
                        <option value="æœªç¨…" {% if contract.tax_type == "æœªç¨…" %}selected{% endif %}>æœªç¨…</option>
                        <option value="å«ç¨…" {% if contract.tax_type == "å«ç¨…" %}selected{% endif %}>å«ç¨…</option>
                    </select>
                </td>
            </tr>
        </table>

        <div style="margin-top:12px;">
            <button type="submit">æ›´æ–°å¥‘ç´„æ¢ä»¶</button>
        </div>
    </form>

    {% endif %}
</body>
</html>
