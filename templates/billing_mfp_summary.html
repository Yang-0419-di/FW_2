{% extends 'layout.html' %}
{% block content %}

<!-- ================= æ¨£å¼ ================= -->
<style>


/* ===== è¡¨æ ¼è‡ªé©æ‡‰ç•«é¢ï¼Œä¸çˆ†ç‰ˆ ===== */
.mfp-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
}

/* æ‰€æœ‰å…§å®¹é å·¦ã€å¯æ›è¡Œ */
.mfp-table th,
.mfp-table td {
    text-align: left !important;
    vertical-align: top;
    word-break: break-word;
    white-space: normal;
    padding: 6px 8px;
    font-size: 14px;
}

/* å°è¢å¹•è‡ªå‹•ç¸®å­— */
@media (max-width: 1400px) {
    .mfp-table th,
    .mfp-table td {
        font-size: 13px;
    }
}
@media (max-width: 1100px) {
    .mfp-table th,
    .mfp-table td {
        font-size: 12px;
    }
}

/* å®¢æˆ¶ç¸½è¡¨å®¹å™¨ */
.table-container.no-scroll {
    width: 100%;
    overflow-x: auto; /* æ°´å¹³å¯æ»‘å‹• */
    overflow-y: visible; /* å‚ç›´è‡ªå‹•æ’é–‹ */
}

/* æœå°‹æ¡† */
.search-box {
    margin: 10px 0 15px 0;
}
.search-box input {
    width: 320px;
    padding: 6px 10px;
    font-size: 16px;
}

/* æ·¡ç´…åº•è‰² */
.bg-warning {
    background-color: #ffcccc;
}

/* è¨­å‚™ä»£è™ŸæŒ‰éˆ• */
.device-btn {
    display: inline-block;
    padding: 4px 10px;
    background-color: #007BFF;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}
.device-btn:hover {
    background-color: #0056b3;
}
</style>

<!-- ================= å°è¦½åˆ— ================= -->
<div style="margin-bottom:10px;">
    <a href="{{ url_for('billing.index') }}"><button class="button-1">TGå®¢æˆ¶ç³»çµ±</button></a>
    <a href="{{ url_for('billing.mfp_summary') }}"><button class="button-1">å®¢æˆ¶ç¸½è¡¨</button></a>
    <a href="{{ url_for('billing.person_page', sheet='æ¹¯å®¶ç‘‹') }}"><button>æ¹¯å®¶ç‘‹</button></a>
    <a href="{{ url_for('billing.person_page', sheet='å³å®—é´»') }}"><button>å³å®—é´»</button></a>
    <a href="{{ url_for('billing.person_page', sheet='åŠ‰æŸå‡') }}"><button>åŠ‰æŸå‡</button></a>
    <button type="button" onclick="history.back()" class="nav-btn-gray">
		â† è¿”å›ä¸Šä¸€é 
	</button>
    <a href="/"><button class="button-3">å›é¦–é </button></a>
</div>

<!-- ===== ç¬¬ä¸€å€å¡Š Accordionï¼ˆå®¢æˆ¶æ•¸é‡ï¼‰ ===== -->
<button class="accordion-button">å®¢æˆ¶æ•¸é‡</button>
<div class="accordion-content">
    <div class="table-container-NO">
        {{ table_area | safe }}
    </div>
</div>

<!-- ===== ç¬¬äºŒå€å¡Š Accordionï¼ˆä¿é¤Šé€±æœŸï¼‰ ===== -->
<button class="accordion-button">ä¿é¤Šé€±æœŸ</button>
<div class="accordion-content">
    <div class="table-container-NO">
        {{ table_cycle | safe }}
    </div>
</div>

<!-- ================= å®¢æˆ¶ç¸½è¡¨ ================= -->
<h2>å®¢æˆ¶ç¸½è¡¨</h2>
<div class="search-box">
  <input type="text" id="customerSearch" placeholder="å³æ™‚æœå°‹ï¼ˆå®¢æˆ¶ / è¨­å‚™ / åœ°å€ / å·¥ç¨‹å¸«â€¦ï¼‰">
</div>

<div class="table-container no-scroll">
  <table class="mfp-table" id="customerTable">
    <thead>
      <tr>
        <th>è¨­å‚™ä»£è™Ÿ</th>
        <th>å®¢æˆ¶åç¨±</th>
        <th>ä¿é¤Šé€±æœŸ</th>
        <th>è¨­å‚™æ©Ÿè™Ÿ</th>
        <th>æ©Ÿå‹</th>
        <th>çµ±ä¸€ç·¨è™Ÿ</th>
        <th>è£æ©Ÿåœ°å€</th>
        <th>å·¥ç¨‹å¸«</th>
        <th>å¥‘ç´„ç·¨è™Ÿ</th>
        <th>åˆç´„èµ·å§‹</th>
        <th>åˆç´„çµæŸ</th>
      </tr>
    </thead>
    <tbody>
      {% for row in tables %}
      <tr>
        <td>
          <a href="{{ url_for('billing.index') }}?device_id={{ row.device_id }}" class="device-btn">{{ row.device_id }}</a>
        </td>
        <td>{{ row.customer_name }}</td>
        <td>{{ row.pm|int }}</td>
        <td>{{ row.device_number|int }}</td>
        <td>{{ row.machine_model }}</td>
        <td>{{ row.tax_id|int }}</td>
        <td>{{ row.install_address }}</td>
        <td>{{ row.service_person }}</td>
        <td>{{ row.contract_number }}</td>
        <td class="date-cell">{{ row.contract_start }}</td>
        <td class="date-cell contract-end {% if row._contract_end_alert %}bg-warning{% endif %}">{{ row.contract_end }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= JS ================= -->
<script>
/* ğŸ” å³æ™‚æœå°‹ */
document.getElementById('customerSearch').addEventListener('input', function () {
    const keyword = this.value.toLowerCase();
    document.querySelectorAll('#customerTable tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(keyword) ? '' : 'none';
    });
});

/* ğŸ“… æ—¥æœŸæ ¼å¼åŒ– YYYY/MM/DD */
const today = new Date();
document.querySelectorAll('.date-cell').forEach(td => {
    const raw = td.innerText.trim();
    if (!raw) return;
    const d = new Date(raw);
    if (!isNaN(d)) {
        td.innerText = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    }
});

/* ğŸ”´ åˆç´„çµæŸå°æ–¼ä¸‰å€‹æœˆåº•è‰² */
document.querySelectorAll('.contract-end').forEach(td => {
    const raw = td.innerText.trim();
    if (!raw) return;
    const d = new Date(raw);
    if (!isNaN(d)) {
        const diffDays = (d - today)/(1000*60*60*24);
        if(diffDays >=0 && diffDays <=90){
            td.classList.add('bg-warning');
        }
    }
});

// Accordion å±•é–‹/æ”¶åˆ JS
document.querySelectorAll('.accordion-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const content = btn.nextElementSibling;

        // æ”¶èµ·å…¶ä»–å…§å®¹
        document.querySelectorAll('.accordion-content').forEach(c => {
            if (c !== content) c.classList.remove('show');
        });

        // åˆ‡æ›ç›®å‰å…§å®¹
        content.classList.toggle('show');
    });
});

</script>

{% endblock %}
